<!-- _includes/load_model.html -->
<div id="model-container" style="background: transparent;"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/utils/BufferGeometryUtils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/modifiers/SimplifyModifier.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Scene setup
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true }); // 'alpha: true' makes the background transparent
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(0x000000, 0); // The second parameter (0) sets the transparency of the clear color
        document.getElementById('model-container').appendChild(renderer.domElement);

        // Lighting
        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(1, 1, 1).normalize();
        scene.add(light);

        // Load the 3D model (GLTF format) asynchronously
        async function loadModel() {
            const loader = new THREE.GLTFLoader();
            try {
                const gltf = await loader.loadAsync('{{ include.gltf_path }}');
                let model = gltf.scene;

                // Simplify the geometry
                model.traverse(function(child) {
                    if (child.isMesh) {
                        const modifier = new THREE.SimplifyModifier();
                        const simplifiedGeometry = modifier.modify(child.geometry, Math.floor(child.geometry.attributes.position.count * 0.6));
                        child.geometry = simplifiedGeometry;
                        child.material = new THREE.MeshBasicMaterial({ color: 0xaaeeFF, wireframe: true });
                    }
                });

                // Scale the model
                const scale = parseFloat('{{ include.scale | default: 1 }}');
                model.scale.set(scale, scale, scale);

                // Add the simplified model to the scene
                scene.add(model);

                // Position the camera
                camera.position.z = 5;

                // Animation loop
                let lastTime = 0;
                const fps = 12; // Set your desired frame rate

                function animate(time) {
                    if (time - lastTime >= 1000 / fps) {
                        lastTime = time;
                        // Rotate the model
                        if (model) {
                            model.rotation.y += 0.01;
                        }

                        // Render the scene
                        renderer.render(scene, camera);
                    }
                    requestAnimationFrame(animate);
                }
                requestAnimationFrame(animate);
            } catch (error) {
                console.error('An error happened during model loading:', error);
            }
        }

        loadModel();

        // Handle window resize
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                const width = window.innerWidth;
                const height = window.innerHeight;
                renderer.setSize(width, height);
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
            }, 200); // Adjust the timeout value as needed
        });

    });
</script>

